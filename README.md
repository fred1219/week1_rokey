# week1_rokey

협동-1: ROS2를 활용한 로봇 자동화 공정 시스템 구현 프로젝트

## 💻 Project
'25.05.14 - '25.05.21 (8일) , 개발인원 4명
### [프로젝트 개요]
조선, 반도체 등 우리나라 제조업의 핵심 산업에서는 고정밀 용접 기술의 수요가 지속적으로 증가하고 있습니다. 그러나 숙련 인력의 감소와 작업 환경의 열악함으로 인해 용접 공정의 자동화가 절실한 상황입니다. 이에 따라 본 프로젝트에서는 협동로봇을 활용한 용접 자동화 시스템을 개발하여 인력난 해소와 생산성 향상을 도모하고자 하였습니다. 이에 협동로봇을 활용한 용접 자동화 시스템 구축 프로젝트를 기획하였습니다.

### [역할] : 

### [프로젝트 개요]
다양한 유형의 용접기능 지원: 규칙적인 2D, 불규칙적인 2D, 규칙적인 3D 용접 기능 지원
ROS2 노드 및 토픽 통신 구현: 실시간 로봇 위치(posx, posj) 수신 및 표시
Doosan API를 활용한 로봇 이동 제어: movej(posj(...)) 명령으로 홈 위치 이동 기능 구현
Tkinter 기반 GUI: 실시간 좌표 확인, 캡처, 복사, CSV 저장, 궤적 계산 기능 포함

### [기능]
- #### 규칙적인 2D
  노드를 UI와 구동제어 2가지로 분리
  UI(클라이언트), M0609(서버) 서비스 구조로 요청,응답을 통해 직접교시 모드 활성화.
  UI => save_posx 버튼을 통해 원하는 지점(시작점, 도착점)을 설정.
  지점(좌표) 설정과 동시에 M0609에서 현재좌표 토픽[/dsr01/msg/current_posx(Float64MultiArray)]을 publish받아 saved_posx 1, 2 변수에 저장.
  위치좌표가 기록된 saved_posx 1, 2 변수를 토픽[/saved_posx_pair(Float64MultiArray)]으로 발행.
  구동제어 노드에서 해당 좌표 데이터를 구독함. 좌표 수신 완료까지 대기(비동기 이벤트 대기 방식<=자세히)
  좌표 수신이 완료되면 M0609로 이동명령 노드[/dsr01//posx_mover]를 발행하여 모션 동작.
  
  
- #### 불규칙적인 2D
  용접할 부분의 도면이나, 센서 등으로 용접로봇이 이동할 경로 정보를 얻어올 수 있다는 시나리오 가정
  따라서 경로에 대한 이미지가 있다는 가정하에 ui에서 이미지를 불러오는 과정부터 시작함.
  이미지 선택 후 용접 포인트 추출버튼을 누르면 이미지 경로에 대해 x,y좌표 추출.
  x,y추출 좌표들을 x축 기준 일정 간격(조정 가능) 정렬하여 sampled 변수에 할당.
  이동 경로 좌표인 sampled 변수(이동 경로 좌표 데이터)를 weld_points.csv로 데이터 로그 저장.
  weld_points.csv에 기록된 x,y를 불러와 이동명령 movel 수행.
  이때 csv에서 불러온 데이터값은 string이므로 float로 재선언, 조인트 rx,ry,rz를 고정값을 주어 pos 변수로 재할당
  
- #### 규칙적인 3D
  a_home.py, movec.py 코드 분리(gui 기능에서 쓰레드 충돌문제로 노드 분리)
##### 개요
ROS2 기반의 산업용 로봇 제어 시스템에서 사용자의 GUI 입력을 통해 3차원 공간상의 3점 좌표를 캡처하고, 이를 바탕으로 원호 궤적의 중심과 반지름을 계산하여 로봇의 원호 이동을 자동화하는 기능을 구현하였습니다.

##### 주요 기능
- **GUI를 통한 좌표 캡처 및 저장**<br/>
사용자가 로봇 TCP의 실시간 좌표를 3회 캡처하여 P1, P2, P3의 위치를 확보하고, CSV 파일로 저장할 수 있는 기능을 개발하였습니다.

- **원의 중심 및 반지름 계산**<br/>
캡처된 3점 좌표 (각각 [X, Y, Z] 형식)를 입력받아 두 선분(P1-P2, P2-P3)의 중점에서 각 선분에 수직인 수직이등분선 방향 벡터를 산출하고, 이들의 교차점으로 원호의 중심을 계산합니다.
이후 중심과 각 점간 거리(반지름)를 계산해 결과의 신뢰성을 검증하고, 예외 조건(점 중복, 세 점 일직선 등)을 처리하여 오류 메시지를 GUI에 출력합니다.

- **원호 경로로 로봇 제어**<br/>
별도의 ROS2 노드에서 CSV로부터 읽은 좌표를 posx 형식으로 변환 후, movel 및 movec 명령으로 원호 경로를 따라 로봇을 제어합니다.
특히, 최종 시작점(P3)으로 이동 후, P2를 경유해 도착점(P1)으로 원호 이동을 수행하며, 3번째 점 캡처 시점과 동시에 용접 시작 명령이 실행되도록 하여 작업 효율성을 높였습니다.

##### 시스템 구조
- 토픽
  - /dsr01/msg/current_posx (Float64MultiArray): 로봇 TCP의 실시간 좌표를 발행
  - /dsr01/msg/joint_state (Float64MultiArray): 로봇 관절 상태 발행
- 서비스
  - 클라이언트: GUI 애플리케이션 내 서비스 클라이언트 노드가 /dsr01/system/set_robot_mode 서비스에 로봇 모드 변경 요청을 수행 (예: 수동모드 0)
  - 서버: 로봇 제어 시스템 내에서 서비스 서버가 모드 변경 명령을 처리

##### 명령 실행
- movec 명령은 별도 제어 노드에서 비동기 스레드로 실행되며, 원호 경로 수행 중에도 GUI 및 ROS 노드가 원활히 작동하도록 하였습니다.
- movec 변수 중 ori=DR_MV_ORI_RADIAL (원주 구속자세)은 ROS2 환경에서 현재 미지원 상태로, 완전한 3D 원호 구속자세 기능은 제한됩니다.
- 이에 따라 본 프로젝트는 XY, YZ, XZ 평면 기준의 2D 원호 궤적 구현 및 시연에 집중하였으며, 3차원 자유 곡면 상의 원호 구현은 추후 개선 예정입니다.

##### 예외 및 오류 처리
  - 동일한 점 캡처 시 계산 중지 및 오류 메시지 출력
  - 세 점이 일직선상에 있을 경우 중심 및 반지름 계산 불가 메시지 처리
  - 선형대수 오류 및 벡터 계산 실패 시 적절한 알림 제공

##### 사용 기술 및 라이브러리
  - Python 3.x, Tkinter (GUI)
  - ROS2 (rclpy, 메시지/서비스)
  - NumPy (수학/벡터 계산)
  - CSV 파일 입출력
  
- #### 안전기능

  
